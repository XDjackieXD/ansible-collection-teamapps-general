- name: zammad_directories
  file:
    path: '{{ item }}'
    state: directory
    owner: root
    group: root
    mode: '0755'
  with_items:
    - '{{ zammad_path }}'
    - '{{ zammad_path }}/data'
    - '{{ zammad_path }}/data/zammad-backup'

- name: zammad elastic search data directory
  file:
    path: '{{ item }}'
    state: directory
    owner: '1000'
    group: root
    mode: '0750'
  with_items:
    - '{{ zammad_path }}/data/elasticsearch-data/'

- name: zammad-data directory
  file:
    path: '{{ item }}'
    state: directory
    owner: '1000'
    group: '1000'
    mode: '0755'
  with_items:
    - '{{ zammad_path }}/data/zammad-data/'

- name: postgresql directory
  file:
    path: '{{ item }}'
    state: directory
    owner: '70'
    group: root
    mode: '0700'
  with_items:
    - '{{ zammad_path }}/data/postgresql-data/'

- name: deploy config
  template:
    src: '{{ item }}'
    dest: '{{ zammad_path }}/{{ item }}'
    owner: root
    group: root
    mode: '0640'
  with_items:
    - docker-compose.yml

- name: env file for secrets
  no_log: true
  template:
    src: env.j2
    dest: '{{ zammad_path }}/.env'
    owner: root
    group: root
    mode: '0640'

- name: include elasticsearch expose tasks
  include_tasks: elasticsearch.yml
  when: zammad_elasticsearch_expose

- name: remove override when not exposed
  file:
    path: '{{ zammad_path }}/docker-compose.override.yml'
    state: absent
  when: not zammad_elasticsearch_expose

- name: custom knowledge base html
  copy:
    content: "{{ zammad_kb_html }}\n"
    dest: '{{ zammad_path }}/knowledge_base.html.erb'
    owner: root
    group: root
    mode: '0644'
  when: zammad_kb_html_custom

- name: zammad_docker-compose-up
  docker_compose:
    project_src: '{{ zammad_path }}'
    state: present
    pull: '{{ zammad_docker_pull }}'
    debug: True
    remove_orphans: True
  register: zammad_compose_return
  changed_when: zammad_compose_return.actions | count > 1 # workaround. zammad-init is always started and stops after init

- name: print compose actions
  debug:
    var: zammad_compose_return.actions
  changed_when: true
  when: zammad_compose_return.actions | count > 1
